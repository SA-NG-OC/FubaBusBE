<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bus Booking System - WebSocket Testing Tool</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }
      .wrapper {
        max-width: 1400px;
        margin: 0 auto;
      }
      .header {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        text-align: center;
      }
      .header h1 {
        color: #667eea;
        font-size: 2.5em;
        margin-bottom: 10px;
      }
      .header p {
        color: #666;
        font-size: 1.1em;
      }
      .container {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      h2 {
        color: #333;
        border-bottom: 3px solid #667eea;
        padding-bottom: 10px;
        margin: 0 0 20px 0;
      }
      h3 {
        color: #555;
        margin: 20px 0 10px 0;
      }
      .status {
        padding: 12px 20px;
        border-radius: 8px;
        margin: 10px 0;
        font-weight: bold;
        display: inline-block;
        min-width: 250px;
        text-align: center;
      }
      .connected {
        background: #d4edda;
        color: #155724;
        border: 2px solid #28a745;
      }
      .disconnected {
        background: #f8d7da;
        color: #721c24;
        border: 2px solid #dc3545;
      }
      input,
      select,
      textarea {
        padding: 10px 15px;
        margin: 5px 0;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.3s;
        font-family: inherit;
      }
      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: #667eea;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        cursor: pointer;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        transition: transform 0.2s, box-shadow 0.2s;
      }
      button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }
      button:active:not(:disabled) {
        transform: translateY(0);
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }
      button.danger {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      }
      button.success {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      }
      .controls {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
        margin: 15px 0;
      }
      .form-group {
        display: flex;
        flex-direction: column;
        margin: 10px 0;
      }
      .form-group label {
        font-weight: 600;
        margin-bottom: 5px;
        color: #555;
      }
      .two-column {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }
      @media (max-width: 768px) {
        .two-column {
          grid-template-columns: 1fr;
        }
      }
      .seat-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 10px;
        margin: 20px 0;
        max-height: 500px;
        overflow-y: auto;
        padding: 15px;
        border: 2px dashed #ddd;
        border-radius: 8px;
        background: #f9f9f9;
      }
      .seat {
        padding: 15px 10px;
        text-align: center;
        border: 3px solid #ddd;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: bold;
        position: relative;
        font-size: 13px;
      }
      .seat::before {
        content: "ü™ë";
        display: block;
        font-size: 28px;
        margin-bottom: 5px;
      }
      .seat.available {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        border-color: #28a745;
      }
      .seat.available:hover {
        transform: scale(1.1) rotate(3deg);
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
      }
      .seat.locked {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        border-color: #ffc107;
        cursor: not-allowed;
      }
      .seat.locked-by-me {
        background: linear-gradient(135deg, #cce5ff 0%, #b8daff 100%);
        border-color: #007bff;
        animation: pulse 2s infinite;
      }
      .seat.locked-by-me:hover {
        transform: scale(1.1);
      }
      .seat.booked {
        background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        border-color: #dc3545;
        cursor: not-allowed;
        opacity: 0.7;
      }
      @keyframes pulse {
        0%,
        100% {
          box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7);
        }
        50% {
          box-shadow: 0 0 0 10px rgba(0, 123, 255, 0);
        }
      }
      .seat-info {
        font-size: 10px;
        margin-top: 5px;
        color: #666;
      }
      .log {
        background: #1e1e1e;
        color: #d4d4d4;
        padding: 15px;
        border-radius: 8px;
        max-height: 450px;
        overflow-y: auto;
        font-family: "Consolas", "Courier New", monospace;
        font-size: 13px;
      }
      .log-entry {
        margin: 5px 0;
        padding: 8px;
        border-left: 4px solid #007bff;
        padding-left: 12px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 4px;
      }
      .log-entry.success {
        border-color: #28a745;
        color: #7dff7d;
      }
      .log-entry.error {
        border-color: #dc3545;
        color: #ff7d7d;
      }
      .log-entry.info {
        border-color: #17a2b8;
        color: #7dd3ff;
      }
      .log-entry.warning {
        border-color: #ffc107;
        color: #ffe97d;
      }
      .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 2px solid #ddd;
      }
      .tab {
        padding: 12px 24px;
        cursor: pointer;
        border: none;
        background: transparent;
        font-weight: 600;
        color: #666;
        border-bottom: 3px solid transparent;
        transition: all 0.3s;
        font-size: 15px;
      }
      .tab:hover {
        color: #667eea;
      }
      .tab.active {
        color: #667eea;
        border-bottom-color: #667eea;
        background: rgba(102, 126, 234, 0.05);
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .trip-info {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #667eea;
        margin: 15px 0;
      }
      .trip-info h4 {
        margin-top: 0;
        color: #667eea;
      }
      .legend {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        margin: 15px 0;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
      }
      .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: white;
        border-radius: 6px;
      }
      .legend-box {
        width: 35px;
        height: 35px;
        border-radius: 6px;
        border: 2px solid;
        flex-shrink: 0;
      }
      .selected-seats {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin: 15px 0;
      }
      .selected-seat-badge {
        background: #007bff;
        color: white;
        padding: 10px 15px;
        border-radius: 20px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .selected-seat-badge button {
        background: rgba(255, 255, 255, 0.3);
        border: none;
        color: white;
        padding: 4px 10px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        margin: 0;
      }
      .selected-seat-badge button:hover {
        background: rgba(255, 255, 255, 0.5);
      }
      .booking-form {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-top: 15px;
      }
      .passenger-card {
        background: white;
        padding: 15px;
        border-radius: 8px;
        margin: 10px 0;
        border: 2px solid #ddd;
      }
      .passenger-card h4 {
        margin-top: 0;
        color: #667eea;
      }
      .model-viewer {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        font-family: "Courier New", monospace;
        font-size: 12px;
        max-height: 400px;
        overflow-y: auto;
      }
      .api-endpoint {
        background: #1e1e1e;
        color: #7dff7d;
        padding: 12px 15px;
        border-radius: 6px;
        font-family: "Consolas", monospace;
        margin: 10px 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
      }
      .api-method {
        background: #667eea;
        padding: 4px 10px;
        border-radius: 4px;
        font-weight: bold;
        margin-right: 10px;
        font-size: 12px;
      }
      .api-method.get {
        background: #28a745;
      }
      .api-method.post {
        background: #007bff;
      }
      .api-method.ws {
        background: #ffc107;
        color: #333;
      }
      .result-box {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
        border-left: 4px solid #28a745;
      }
      .result-box.error {
        border-left-color: #dc3545;
        background: #fff5f5;
      }
      .badge {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        margin: 2px;
      }
      .badge.confirmed {
        background: #d4edda;
        color: #155724;
      }
      .badge.pending {
        background: #fff3cd;
        color: #856404;
      }
      .badge.cancelled {
        background: #f8d7da;
        color: #721c24;
      }
    </style>
  </head>
  <body>
    <div class="wrapper">
      <div class="header">
        <h1>üöå Bus Booking System - WebSocket Testing Tool</h1>
        <p>
          Complete testing suite for seat locking, real-time updates, and
          booking flow
        </p>
      </div>

      <!-- Connection Section -->
      <div class="container">
        <h2>‚öôÔ∏è 1. K·∫øt n·ªëi WebSocket</h2>
        <div class="form-group">
          <label>üåê Server URL:</label>
          <input
            type="text"
            id="serverUrl"
            value="http://localhost:5230/ws"
            style="width: 100%"
          />
        </div>
        <div class="controls">
          <div class="form-group" style="margin: 0">
            <label>üé´ Trip ID:</label>
            <input type="number" id="tripId" value="1" style="width: 120px" />
          </div>
          <div class="form-group" style="margin: 0">
            <label>üë§ User ID:</label>
            <input
              type="text"
              id="userId"
              value="user_test_1"
              style="width: 200px"
            />
          </div>
          <button onclick="connect()">üîå K·∫øt n·ªëi WebSocket</button>
          <button
            onclick="disconnect()"
            id="disconnectBtn"
            disabled
            class="danger"
          >
            üîå Ng·∫Øt k·∫øt n·ªëi
          </button>
        </div>
        <div id="connectionStatus" class="status disconnected">
          ‚ùå Ch∆∞a k·∫øt n·ªëi - Vui l√≤ng nh·∫≠p th√¥ng tin v√† click K·∫øt n·ªëi
        </div>
      </div>

      <!-- Tabs Container -->
      <div class="container">
        <div class="tabs">
          <button class="tab active" onclick="switchTab('seats')">
            ü™ë S∆° ƒë·ªì gh·∫ø & Locking
          </button>
          <button class="tab" onclick="switchTab('booking')">
            üìù ƒê·∫∑t v√© (Booking)
          </button>
          <button class="tab" onclick="switchTab('models')">
            üìä Models & API
          </button>
          <button class="tab" onclick="switchTab('logs')">üìã Logs</button>
        </div>

        <!-- Tab 1: Seat Map -->
        <div id="tab-seats" class="tab-content active">
          <h2>ü™ë 2. Xem s∆° ƒë·ªì gh·∫ø & Test Locking</h2>

          <div class="controls">
            <button onclick="loadSeats()" class="success">
              üì• T·∫£i s∆° ƒë·ªì gh·∫ø
            </button>
            <button onclick="createTestSeats()">üîß T·∫°o test seats</button>
            <button onclick="releaseAllMyLocks()" class="danger">
              üîì Gi·∫£i ph√≥ng gh·∫ø c·ªßa t√¥i
            </button>
          </div>

          <div id="tripInfo" class="trip-info" style="display: none">
            <h4>üìç Th√¥ng tin chuy·∫øn xe</h4>
            <div id="tripDetails"></div>
          </div>

          <div class="legend">
            <div class="legend-item">
              <div
                class="legend-box"
                style="
                  background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
                  border-color: #28a745;
                "
              ></div>
              <span><strong>Available</strong> - Gh·∫ø tr·ªëng (click ƒë·ªÉ gi·ªØ)</span>
            </div>
            <div class="legend-item">
              <div
                class="legend-box"
                style="
                  background: linear-gradient(135deg, #cce5ff 0%, #b8daff 100%);
                  border-color: #007bff;
                "
              ></div>
              <span><strong>Held (C·ªßa t√¥i)</strong> - Click ƒë·ªÉ b·ªè gi·ªØ</span>
            </div>
            <div class="legend-item">
              <div
                class="legend-box"
                style="
                  background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
                  border-color: #ffc107;
                "
              ></div>
              <span><strong>Held (Ng∆∞·ªùi kh√°c)</strong></span>
            </div>
            <div class="legend-item">
              <div
                class="legend-box"
                style="
                  background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
                  border-color: #dc3545;
                "
              ></div>
              <span><strong>Booked</strong> - ƒê√£ ƒë∆∞·ª£c ƒë·∫∑t</span>
            </div>
          </div>

          <h3>S∆° ƒë·ªì gh·∫ø:</h3>
          <div id="seatGrid" class="seat-grid">
            <p style="text-align: center; color: #999; grid-column: 1/-1">
              Click "T·∫£i s∆° ƒë·ªì gh·∫ø" ƒë·ªÉ xem danh s√°ch gh·∫ø
            </p>
          </div>
        </div>

        <!-- Tab 2: Booking -->
        <div id="tab-booking" class="tab-content">
          <h2>üìù 3. ƒê·∫∑t v√© (Booking API)</h2>

          <h3>Gh·∫ø ƒë√£ ch·ªçn:</h3>
          <div class="selected-seats" id="selectedSeatsDisplay">
            <p style="color: #999">
              Ch∆∞a c√≥ gh·∫ø n√†o ƒë∆∞·ª£c ch·ªçn. V√†o tab "S∆° ƒë·ªì gh·∫ø" ƒë·ªÉ ch·ªçn gh·∫ø (click
              v√†o gh·∫ø Available).
            </p>
          </div>

          <div class="booking-form">
            <h3>üë§ Th√¥ng tin kh√°ch h√†ng</h3>
            <div class="two-column">
              <div class="form-group">
                <label>H·ªç t√™n:</label>
                <input
                  type="text"
                  id="customerName"
                  value="Nguy·ªÖn VƒÉn A"
                  style="width: 100%"
                />
              </div>
              <div class="form-group">
                <label>S·ªë ƒëi·ªán tho·∫°i:</label>
                <input
                  type="text"
                  id="customerPhone"
                  value="0901234567"
                  style="width: 100%"
                />
              </div>
            </div>
            <div class="form-group">
              <label>Email:</label>
              <input
                type="email"
                id="customerEmail"
                value="nguyenvana@example.com"
                style="width: 100%"
              />
            </div>

            <h3>üé´ Th√¥ng tin h√†nh kh√°ch</h3>
            <div id="passengerForms"></div>

            <div class="controls" style="margin-top: 20px">
              <button onclick="previewBooking()" class="success">
                üëÅÔ∏è Xem tr∆∞·ªõc (Preview)
              </button>
              <button onclick="confirmBookingAPI()">‚úÖ X√°c nh·∫≠n ƒë·∫∑t v√©</button>
            </div>
          </div>

          <div id="bookingResult"></div>
        </div>

        <!-- Tab 3: Models & API -->
        <div id="tab-models" class="tab-content">
          <h2>üìä 4. Models & API Documentation</h2>

          <h3>üîó API Endpoints</h3>
          <div class="api-endpoint">
            <div>
              <span class="api-method get">GET</span>/trips/seats/{tripId}
            </div>
            <span>Xem s∆° ƒë·ªì gh·∫ø</span>
          </div>
          <div class="api-endpoint">
            <div>
              <span class="api-method post">POST</span
              >/trips/{tripId}/seat-map/migrate
            </div>
            <span>T·∫°o test seats</span>
          </div>
          <div class="api-endpoint">
            <div><span class="api-method ws">WS</span>/app/seat/lock</div>
            <span>Gi·ªØ gh·∫ø (WebSocket)</span>
          </div>
          <div class="api-endpoint">
            <div><span class="api-method ws">WS</span>/app/seat/unlock</div>
            <span>B·ªè gi·ªØ gh·∫ø (WebSocket)</span>
          </div>
          <div class="api-endpoint">
            <div>
              <span class="api-method post">POST</span>/bookings/confirm
            </div>
            <span>X√°c nh·∫≠n ƒë·∫∑t v√©</span>
          </div>
          <div class="api-endpoint">
            <div><span class="api-method get">GET</span>/bookings/preview</div>
            <span>Xem tr∆∞·ªõc booking</span>
          </div>
          <div class="api-endpoint">
            <div>
              <span class="api-method post">POST</span>/bookings/{id}/cancel
            </div>
            <span>H·ªßy v√©</span>
          </div>

          <h3>üì¶ Data Models</h3>
          <div class="model-viewer">
            <pre><strong>SeatStatusMessage</strong> (WebSocket Response)
{
  "type": "Held" | "UNLOCKED" | "EXPIRED" | "Booked",
  "seatId": 1,
  "seatNumber": "A1",
  "status": "Available" | "Held" | "Booked",
  "lockedBy": "user_test_1",
  "lockExpiry": "2026-01-06T10:15:00",
  "success": true,
  "message": "Seat locked successfully"
}

<strong>BookingConfirmRequest</strong>
{
  "tripId": 1,
  "seatIds": [1, 2],
  "userId": "user_test_1",
  "customerName": "Nguy·ªÖn VƒÉn A",
  "customerPhone": "0901234567",
  "customerEmail": "nguyenvana@example.com",
  "passengers": [
    {
      "seatId": 1,
      "fullName": "Nguy·ªÖn VƒÉn A",
      "pickupAddress": "B·∫øn xe Mi·ªÅn ƒê√¥ng",
      "dropoffAddress": "B·∫øn xe ƒê√† L·∫°t"
    }
  ],
  "isGuestBooking": false
}

<strong>BookingResponse</strong>
{
  "success": true,
  "bookingId": 1,
  "bookingCode": "BK20260106001",
  "bookingStatus": "Paid",
  "totalAmount": 300000,
  "tripInfo": {
    "tripId": 1,
    "routeName": "TP.HCM - ƒê√† L·∫°t",
    "departureTime": "2026-01-07T08:00:00",
    "arrivalTime": "2026-01-07T14:00:00"
  },
  "tickets": [
    {
      "ticketId": 1,
      "ticketCode": "TK20260106001",
      "seatNumber": "A1",
      "passengerName": "Nguy·ªÖn VƒÉn A",
      "price": 150000,
      "status": "Paid"
    }
  ]
}

<strong>TripSeat</strong> (Entity)
{
  "seatId": 1,
  "seatNumber": "A1",
  "seatType": "VIP",
  "floor": 1,
  "status": "Available" | "Held" | "Booked",
  "lockedBySessionId": "user_test_1",
  "lockExpiry": "2026-01-06T10:15:00",
  "price": 150000
}</pre>
          </div>

          <h3>üîÑ Lu·ªìng ho·∫°t ƒë·ªông (Workflow)</h3>
          <div class="trip-info">
            <ol style="line-height: 2">
              <li>
                <strong>K·∫øt n·ªëi WebSocket:</strong> Client k·∫øt n·ªëi t·ªõi /ws
                endpoint
              </li>
              <li>
                <strong>Subscribe topics:</strong>
                <ul>
                  <li>
                    /topic/trips/{tripId}/seats - Nh·∫≠n broadcast khi gh·∫ø thay
                    ƒë·ªïi
                  </li>
                  <li>/user/queue/seat/response - Nh·∫≠n response c√° nh√¢n</li>
                </ul>
              </li>
              <li><strong>Xem s∆° ƒë·ªì gh·∫ø:</strong> GET /trips/seats/{tripId}</li>
              <li>
                <strong>Gi·ªØ gh·∫ø (Locking):</strong> Send message t·ªõi
                /app/seat/lock
                <ul>
                  <li>Server ki·ªÉm tra gh·∫ø available</li>
                  <li>Lock gh·∫ø v·ªõi PESSIMISTIC_WRITE</li>
                  <li>Broadcast tr·∫°ng th√°i m·ªõi cho t·∫•t c·∫£ clients</li>
                  <li>T·ª± ƒë·ªông expire sau 5 ph√∫t</li>
                </ul>
              </li>
              <li>
                <strong>ƒê·∫∑t v√© (Booking):</strong> POST /bookings/confirm
                <ul>
                  <li>Validate gh·∫ø ƒëang locked b·ªüi user</li>
                  <li>T·∫°o Booking + Tickets v·ªõi @Transactional</li>
                  <li>Chuy·ªÉn tr·∫°ng th√°i gh·∫ø th√†nh Booked</li>
                  <li>Broadcast c·∫≠p nh·∫≠t realtime</li>
                  <li>Tr·∫£ v·ªÅ booking code v√† ticket codes</li>
                </ul>
              </li>
              <li>
                <strong>H·ªßy v√©:</strong> POST /bookings/{id}/cancel
                <ul>
                  <li>Chuy·ªÉn booking status th√†nh CANCELLED</li>
                  <li>Gi·∫£i ph√≥ng gh·∫ø v·ªÅ Available</li>
                  <li>Broadcast c·∫≠p nh·∫≠t</li>
                </ul>
              </li>
            </ol>
          </div>
        </div>

        <!-- Tab 4: Logs -->
        <div id="tab-logs" class="tab-content">
          <h2>üìã 5. Activity Logs</h2>
          <div class="controls">
            <button onclick="clearLogs()" class="danger">üóëÔ∏è X√≥a logs</button>
            <button onclick="exportLogs()" class="success">
              üíæ Export logs
            </button>
          </div>
          <div id="logContainer" class="log">
            <div class="log-entry info">
              Ch√†o m·ª´ng! H√£y k·∫øt n·ªëi WebSocket ƒë·ªÉ b·∫Øt ƒë·∫ßu.
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Global variables
      let stompClient = null;
      let currentTripId = null;
      let currentUserId = null;
      let seats = new Map();
      let selectedSeats = new Set();

      // Logging function
      function log(message, type = "info") {
        const logContainer = document.getElementById("logContainer");
        const entry = document.createElement("div");
        entry.className = `log-entry ${type}`;
        const timestamp = new Date().toLocaleTimeString();
        entry.textContent = `[${timestamp}] ${message}`;
        logContainer.insertBefore(entry, logContainer.firstChild);
      }

      // Tab switching
      function switchTab(tabName) {
        // Remove active from all tabs
        document
          .querySelectorAll(".tab")
          .forEach((tab) => tab.classList.remove("active"));
        document
          .querySelectorAll(".tab-content")
          .forEach((content) => content.classList.remove("active"));

        // Add active to selected tab
        event.target.classList.add("active");
        document.getElementById(`tab-${tabName}`).classList.add("active");

        log(`Chuy·ªÉn sang tab: ${tabName}`, "info");
      }

      // WebSocket connection
      function connect() {
        const serverUrl = document.getElementById("serverUrl").value;
        currentTripId = document.getElementById("tripId").value;
        currentUserId = document.getElementById("userId").value;

        if (!serverUrl || !currentTripId || !currentUserId) {
          alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
          return;
        }

        log(`ƒêang k·∫øt n·ªëi t·ªõi ${serverUrl}...`, "info");

        const socket = new SockJS(serverUrl);
        stompClient = Stomp.over(socket);

        stompClient.connect(
          {},
          function (frame) {
            log("‚úÖ K·∫øt n·ªëi WebSocket th√†nh c√¥ng!", "success");
            document.getElementById("connectionStatus").className =
              "status connected";
            document.getElementById(
              "connectionStatus"
            ).textContent = `‚úÖ ƒê√£ k·∫øt n·ªëi - Trip #${currentTripId} - User: ${currentUserId}`;
            document.getElementById("disconnectBtn").disabled = false;

            // Subscribe to seat updates
            const topic = `/topic/trips/${currentTripId}/seats`;
            log(`Subscribe to: ${topic}`, "info");

            stompClient.subscribe(topic, function (message) {
              const seatUpdate = JSON.parse(message.body);
              log(
                `üì¢ Broadcast: ${seatUpdate.type} - Seat ${
                  seatUpdate.seatNumber || seatUpdate.seatId
                }`,
                "info"
              );
              console.log("Seat update:", seatUpdate);
              updateSeatUI(seatUpdate);
            });

            // Subscribe to personal responses
            stompClient.subscribe(
              "/user/queue/seat/response",
              function (message) {
                const response = JSON.parse(message.body);
                if (response.success) {
                  log(
                    `‚úÖ ${response.type}: Seat ${response.seatId} - ${response.message}`,
                    "success"
                  );
                } else {
                  log(`‚ùå ${response.type}: ${response.message}`, "error");
                }
              }
            );

            // Auto-load seats
            loadSeats();
          },
          function (error) {
            log(`‚ùå L·ªói k·∫øt n·ªëi: ${error}`, "error");
            document.getElementById("connectionStatus").className =
              "status disconnected";
            document.getElementById("connectionStatus").textContent =
              "‚ùå L·ªói k·∫øt n·ªëi";
          }
        );
      }

      function disconnect() {
        if (stompClient !== null) {
          stompClient.disconnect();
          log("ƒê√£ ng·∫Øt k·∫øt n·ªëi WebSocket", "warning");
        }
        document.getElementById("connectionStatus").className =
          "status disconnected";
        document.getElementById("connectionStatus").textContent =
          "‚ùå ƒê√£ ng·∫Øt k·∫øt n·ªëi";
        document.getElementById("disconnectBtn").disabled = true;
      }

      // Seat operations
      function lockSeat(seatId) {
        if (!stompClient || !stompClient.connected) {
          alert("Vui l√≤ng k·∫øt n·ªëi WebSocket tr∆∞·ªõc!");
          return;
        }

        const message = {
          seatId: parseInt(seatId),
          tripId: parseInt(currentTripId),
          userId: currentUserId,
        };

        log(`üîí ƒêang g·ª≠i lock request cho seat ${seatId}...`, "info");
        stompClient.send("/app/seat/lock", {}, JSON.stringify(message));
      }

      function unlockSeat(seatId) {
        if (!stompClient || !stompClient.connected) {
          alert("Vui l√≤ng k·∫øt n·ªëi WebSocket tr∆∞·ªõc!");
          return;
        }

        const message = {
          seatId: parseInt(seatId),
          tripId: parseInt(currentTripId),
          userId: currentUserId,
        };

        log(`üîì ƒêang g·ª≠i unlock request cho seat ${seatId}...`, "info");
        stompClient.send("/app/seat/unlock", {}, JSON.stringify(message));
      }

      async function loadSeats() {
        const tripId = document.getElementById("tripId").value;
        log(`ƒêang t·∫£i danh s√°ch gh·∫ø cho trip ${tripId}...`, "info");

        try {
          const response = await fetch(
            `http://localhost:5230/trips/seats/${tripId}`
          );
          const data = await response.json();

          if (data.success && data.data && data.data.floors) {
            seats.clear();
            selectedSeats.clear();

            let totalSeats = 0;
            data.data.floors.forEach((floor) => {
              floor.seats.forEach((seat) => {
                seats.set(seat.seatId, seat);
                totalSeats++;

                // Auto-select locked seats by current user
                if (seat.status === "Held" && seat.lockedBy === currentUserId) {
                  selectedSeats.add(seat.seatId);
                }
              });
            });

            // Display trip info
            const tripInfo = data.data;
            document.getElementById("tripDetails").innerHTML = `
                        <p><strong>Route:</strong> ${
                          tripInfo.routeName || "N/A"
                        }</p>
                        <p><strong>Vehicle:</strong> ${
                          tripInfo.vehicleType || "N/A"
                        }</p>
                        <p><strong>Total Seats:</strong> ${totalSeats}</p>
                    `;
            document.getElementById("tripInfo").style.display = "block";

            renderSeats();
            updateSelectedSeatsDisplay();
            log(`‚úÖ ƒê√£ t·∫£i ${totalSeats} gh·∫ø`, "success");
          } else {
            log(
              `‚ö†Ô∏è Ch∆∞a c√≥ seats cho trip ${tripId}. T·∫°o test seats tr∆∞·ªõc!`,
              "warning"
            );
            document.getElementById("seatGrid").innerHTML =
              '<p style="text-align: center; color: #999; grid-column: 1/-1;">Ch∆∞a c√≥ gh·∫ø n√†o. Click "T·∫°o test seats".</p>';
          }
        } catch (error) {
          log(`‚ùå L·ªói t·∫£i seats: ${error.message}`, "error");
        }
      }

      function renderSeats() {
        const grid = document.getElementById("seatGrid");
        grid.innerHTML = "";

        if (seats.size === 0) {
          grid.innerHTML =
            '<p style="text-align: center; color: #999; grid-column: 1/-1;">Ch∆∞a c√≥ gh·∫ø n√†o. Click "T·∫°o test seats".</p>';
          return;
        }

        seats.forEach((seat, seatId) => {
          const seatDiv = document.createElement("div");
          seatDiv.className = "seat";
          seatDiv.id = `seat-${seatId}`;

          let className = "available";
          let statusText = "‚úÖ Tr·ªëng";
          let statusEnum = seat.status || "Available";

          if (statusEnum === "Booked") {
            className = "booked";
            statusText = "‚ùå ƒê√£ ƒë·∫∑t";
          } else if (statusEnum === "Held") {
            if (seat.lockedBy === currentUserId) {
              className = "locked-by-me";
              statusText = "üîí C·ªßa t√¥i";
            } else {
              className = "locked";
              statusText = "‚è≥ ƒêang gi·ªØ";
            }
          }

          seatDiv.className += " " + className;

          const expiryInfo = seat.lockExpiry
            ? `<div class="seat-info">H·∫øt h·∫°n: ${new Date(
                seat.lockExpiry
              ).toLocaleTimeString()}</div>`
            : "";
          const lockedByInfo = seat.lockedBy
            ? `<div class="seat-info">B·ªüi: ${seat.lockedBy.substring(
                0,
                10
              )}...</div>`
            : "";
          const priceInfo = seat.price
            ? `<div class="seat-info">Gi√°: ${seat.price.toLocaleString()}ƒë</div>`
            : "";

          seatDiv.innerHTML = `
                    <div><strong>${
                      seat.seatNumber || "Seat " + seatId
                    }</strong></div>
                    <div style="font-size: 11px;">${statusText}</div>
                    ${priceInfo}
                    ${lockedByInfo}
                    ${expiryInfo}
                `;

          if (className === "available") {
            seatDiv.onclick = () => {
              lockSeat(seatId);
              selectedSeats.add(seatId);
            };
          } else if (className === "locked-by-me") {
            seatDiv.onclick = () => {
              if (confirm(`B·ªè gi·ªØ gh·∫ø ${seat.seatNumber}?`)) {
                unlockSeat(seatId);
                selectedSeats.delete(seatId);
                updateSelectedSeatsDisplay();
              }
            };
          }

          grid.appendChild(seatDiv);
        });
      }

      function updateSeatUI(seatUpdate) {
        if (!seatUpdate.seatId) return;

        // Update in-memory seat data
        const seat = seats.get(seatUpdate.seatId) || {};
        seat.seatId = seatUpdate.seatId;
        seat.seatNumber = seatUpdate.seatNumber || seat.seatNumber;
        seat.status = seatUpdate.status;
        seat.lockedBy = seatUpdate.lockedBy;
        seat.lockExpiry = seatUpdate.lockExpiry;
        seats.set(seatUpdate.seatId, seat);

        // Update selected seats
        if (
          seatUpdate.status === "Held" &&
          seatUpdate.lockedBy === currentUserId
        ) {
          selectedSeats.add(seatUpdate.seatId);
        } else if (
          seatUpdate.status !== "Held" ||
          seatUpdate.lockedBy !== currentUserId
        ) {
          selectedSeats.delete(seatUpdate.seatId);
        }

        // Re-render seats
        renderSeats();
        updateSelectedSeatsDisplay();
      }

      async function createTestSeats() {
        const tripId = document.getElementById("tripId").value;
        log(`ƒêang t·∫°o test seats cho trip ${tripId}...`, "info");

        try {
          const response = await fetch(
            `http://localhost:5230/trips/${tripId}/seat-map/migrate`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ overwrite: true }),
            }
          );

          const data = await response.json();

          if (data.success) {
            log(`‚úÖ ƒê√£ t·∫°o test seats th√†nh c√¥ng!`, "success");
            await loadSeats();
          } else {
            log(`‚ùå L·ªói t·∫°o seats: ${data.message}`, "error");
          }
        } catch (error) {
          log(`‚ùå L·ªói: ${error.message}`, "error");
        }
      }

      function releaseAllMyLocks() {
        if (!confirm("Gi·∫£i ph√≥ng t·∫•t c·∫£ gh·∫ø b·∫°n ƒëang gi·ªØ?")) return;

        selectedSeats.forEach((seatId) => {
          unlockSeat(seatId);
        });

        selectedSeats.clear();
        updateSelectedSeatsDisplay();
        log("ƒê√£ g·ª≠i y√™u c·∫ßu gi·∫£i ph√≥ng t·∫•t c·∫£ gh·∫ø", "info");
      }

      // Booking operations
      function updateSelectedSeatsDisplay() {
        const display = document.getElementById("selectedSeatsDisplay");
        const passengerForms = document.getElementById("passengerForms");

        if (selectedSeats.size === 0) {
          display.innerHTML =
            '<p style="color: #999;">Ch∆∞a c√≥ gh·∫ø n√†o ƒë∆∞·ª£c ch·ªçn. V√†o tab "S∆° ƒë·ªì gh·∫ø" ƒë·ªÉ ch·ªçn gh·∫ø (click v√†o gh·∫ø Available).</p>';
          passengerForms.innerHTML =
            '<p style="color: #999;">Ch·ªçn gh·∫ø tr∆∞·ªõc ƒë·ªÉ nh·∫≠p th√¥ng tin h√†nh kh√°ch</p>';
          return;
        }

        // Display selected seats
        let html = "";
        selectedSeats.forEach((seatId) => {
          const seat = seats.get(seatId);
          if (seat) {
            html += `
                        <div class="selected-seat-badge">
                            <span>Gh·∫ø ${seat.seatNumber}</span>
                            <span>${
                              seat.price
                                ? seat.price.toLocaleString() + "ƒë"
                                : ""
                            }</span>
                            <button onclick="removeSeat(${seatId})">√ó</button>
                        </div>
                    `;
          }
        });
        display.innerHTML = html;

        // Generate passenger forms
        html = "";
        let index = 1;
        selectedSeats.forEach((seatId) => {
          const seat = seats.get(seatId);
          if (seat) {
            html += `
                        <div class="passenger-card">
                            <h4>üé´ H√†nh kh√°ch #${index} - Gh·∫ø ${seat.seatNumber}</h4>
                            <div class="form-group">
                                <label>H·ªç t√™n:</label>
                                <input type="text" class="passenger-name" data-seat-id="${seatId}" 
                                       value="H√†nh kh√°ch ${index}" style="width: 100%;">
                            </div>
                            <div class="two-column">
                                <div class="form-group">
                                    <label>ƒê·ªãa ch·ªâ ƒë√≥n:</label>
                                    <input type="text" class="passenger-pickup" data-seat-id="${seatId}" 
                                           value="B·∫øn xe Mi·ªÅn ƒê√¥ng" style="width: 100%;">
                                </div>
                                <div class="form-group">
                                    <label>ƒê·ªãa ch·ªâ tr·∫£:</label>
                                    <input type="text" class="passenger-dropoff" data-seat-id="${seatId}" 
                                           value="B·∫øn xe ƒê√† L·∫°t" style="width: 100%;">
                                </div>
                            </div>
                        </div>
                    `;
            index++;
          }
        });
        passengerForms.innerHTML = html;
      }

      function removeSeat(seatId) {
        selectedSeats.delete(seatId);
        unlockSeat(seatId);
        updateSelectedSeatsDisplay();
      }

      async function previewBooking() {
        if (selectedSeats.size === 0) {
          alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 gh·∫ø!");
          return;
        }

        const seatIds = Array.from(selectedSeats);
        const userId = document.getElementById("userId").value;

        log("ƒêang xem tr∆∞·ªõc booking...", "info");

        try {
          const url = `http://localhost:5230/bookings/preview?tripId=${currentTripId}&userId=${userId}&seatIds=${seatIds.join(
            ","
          )}`;
          const response = await fetch(url);
          const data = await response.json();

          const result = document.getElementById("bookingResult");
          if (data.success) {
            const issues = data.data.issues || [];
            result.innerHTML = `
                        <div class="result-box">
                            <h3>‚úÖ Preview Booking</h3>
                            <p><strong>Valid:</strong> ${
                              data.data.valid ? "Yes" : "No"
                            }</p>
                            <p><strong>Total Amount:</strong> ${data.data.totalAmount.toLocaleString()}ƒë</p>
                            ${
                              issues.length > 0
                                ? "<p><strong>Issues:</strong> " +
                                  issues.join(", ") +
                                  "</p>"
                                : ""
                            }
                        </div>
                    `;
            log("‚úÖ Preview th√†nh c√¥ng", "success");
          } else {
            result.innerHTML = `
                        <div class="result-box error">
                            <h3>‚ùå Error</h3>
                            <p>${data.message}</p>
                        </div>
                    `;
            log(`‚ùå Preview th·∫•t b·∫°i: ${data.message}`, "error");
          }
        } catch (error) {
          log(`‚ùå L·ªói: ${error.message}`, "error");
        }
      }

      async function confirmBookingAPI() {
        if (selectedSeats.size === 0) {
          alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 gh·∫ø!");
          return;
        }

        if (!confirm(`X√°c nh·∫≠n ƒë·∫∑t ${selectedSeats.size} gh·∫ø?`)) return;

        const seatIds = Array.from(selectedSeats);
        const passengers = [];

        // Collect passenger info
        document.querySelectorAll(".passenger-name").forEach((input) => {
          const seatId = parseInt(input.getAttribute("data-seat-id"));
          const pickup = document.querySelector(
            `.passenger-pickup[data-seat-id="${seatId}"]`
          ).value;
          const dropoff = document.querySelector(
            `.passenger-dropoff[data-seat-id="${seatId}"]`
          ).value;

          passengers.push({
            seatId: seatId,
            fullName: input.value,
            pickupAddress: pickup,
            dropoffAddress: dropoff,
          });
        });

        const requestBody = {
          tripId: parseInt(currentTripId),
          seatIds: seatIds,
          userId: document.getElementById("userId").value,
          customerName: document.getElementById("customerName").value,
          customerPhone: document.getElementById("customerPhone").value,
          customerEmail: document.getElementById("customerEmail").value,
          passengers: passengers,
          isGuestBooking: false,
        };

        log("ƒêang g·ª≠i booking request...", "info");

        try {
          const response = await fetch(
            "http://localhost:5230/bookings/confirm",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(requestBody),
            }
          );

          const data = await response.json();
          const result = document.getElementById("bookingResult");

          if (data.success) {
            const booking = data.data;
            let ticketsHtml = "";
            booking.tickets.forEach((ticket) => {
              ticketsHtml += `
                            <div style="background: white; padding: 10px; margin: 5px 0; border-radius: 6px;">
                                <strong>${ticket.ticketCode}</strong> - Gh·∫ø ${
                ticket.seatNumber
              } - 
                                ${
                                  ticket.passengerName
                                } - ${ticket.price.toLocaleString()}ƒë
                                <span class="badge ${ticket.status.toLowerCase()}">${
                ticket.status
              }</span>
                            </div>
                        `;
            });

            result.innerHTML = `
                        <div class="result-box">
                            <h3>‚úÖ ƒê·∫∑t v√© th√†nh c√¥ng!</h3>
                            <p><strong>Booking Code:</strong> ${
                              booking.bookingCode
                            }</p>
                            <p><strong>Status:</strong> <span class="badge ${booking.bookingStatus.toLowerCase()}">${
              booking.bookingStatus
            }</span></p>
                            <p><strong>Total Amount:</strong> ${booking.totalAmount.toLocaleString()}ƒë</p>
                            <h4>V√© c·ªßa b·∫°n:</h4>
                            ${ticketsHtml}
                        </div>
                    `;

            log(
              `‚úÖ ƒê·∫∑t v√© th√†nh c√¥ng! Booking code: ${booking.bookingCode}`,
              "success"
            );

            // Clear selected seats
            selectedSeats.clear();
            updateSelectedSeatsDisplay();

            // Reload seats
            setTimeout(() => loadSeats(), 1000);
          } else {
            result.innerHTML = `
                        <div class="result-box error">
                            <h3>‚ùå ƒê·∫∑t v√© th·∫•t b·∫°i</h3>
                            <p>${data.message}</p>
                        </div>
                    `;
            log(`‚ùå ƒê·∫∑t v√© th·∫•t b·∫°i: ${data.message}`, "error");
          }
        } catch (error) {
          log(`‚ùå L·ªói: ${error.message}`, "error");
        }
      }

      // Utility functions
      function clearLogs() {
        document.getElementById("logContainer").innerHTML = "";
        log("Logs ƒë√£ ƒë∆∞·ª£c x√≥a", "info");
      }

      function exportLogs() {
        const logs = document.getElementById("logContainer").innerText;
        const blob = new Blob([logs], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `websocket-logs-${Date.now()}.txt`;
        a.click();
        log("Logs ƒë√£ ƒë∆∞·ª£c export", "success");
      }

      // Initialize
      window.onload = function () {
        log("WebSocket Testing Tool ƒë√£ s·∫µn s√†ng!", "success");
        log(
          'H√£y nh·∫≠p th√¥ng tin v√† click "K·∫øt n·ªëi WebSocket" ƒë·ªÉ b·∫Øt ƒë·∫ßu',
          "info"
        );
      };
    </script>
  </body>
</html>
