<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test WebSocket - Bus Booking System</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }
      .header {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        text-align: center;
      }
      .header h1 {
        margin: 0;
        color: #667eea;
        font-size: 2.5em;
      }
      .header p {
        margin: 10px 0 0 0;
        color: #666;
        font-size: 1.1em;
      }
      .container {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      h2 {
        color: #333;
        border-bottom: 3px solid #667eea;
        padding-bottom: 10px;
        margin-top: 0;
      }
      h3 {
        color: #555;
        margin-top: 20px;
      }
      .status {
        padding: 12px 20px;
        border-radius: 8px;
        margin: 10px 0;
        font-weight: bold;
        display: inline-block;
        min-width: 200px;
        text-align: center;
      }
      .connected {
        background: #d4edda;
        color: #155724;
        border: 2px solid #28a745;
      }
      .disconnected {
        background: #f8d7da;
        color: #721c24;
        border: 2px solid #dc3545;
      }
      input,
      select,
      textarea {
        padding: 10px 15px;
        margin: 5px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.3s;
      }
      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: #667eea;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        cursor: pointer;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        transition: transform 0.2s, box-shadow 0.2s;
      }
      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }
      button:active {
        transform: translateY(0);
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }
      button.danger {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      }
      button.success {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      }
      .two-column {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }
      @media (max-width: 768px) {
        .two-column {
          grid-template-columns: 1fr;
        }
      }
      .seat-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 10px;
        margin: 20px 0;
        max-height: 400px;
        overflow-y: auto;
        padding: 10px;
        border: 2px dashed #ddd;
        border-radius: 8px;
      }
      .seat {
        padding: 15px;
        text-align: center;
        border: 3px solid #ddd;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: bold;
        position: relative;
      }
      .seat::before {
        content: "ü™ë";
        display: block;
        font-size: 24px;
        margin-bottom: 5px;
      }
      .seat.available {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        border-color: #28a745;
      }
      .seat.available:hover {
        transform: scale(1.1) rotate(3deg);
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
      }
      .seat.locked {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        border-color: #ffc107;
        cursor: not-allowed;
      }
      .seat.locked-by-me {
        background: linear-gradient(135deg, #cce5ff 0%, #b8daff 100%);
        border-color: #007bff;
        animation: pulse 2s infinite;
      }
      .seat.locked-by-me:hover {
        transform: scale(1.1);
      }
      .seat.booked {
        background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        border-color: #dc3545;
        cursor: not-allowed;
        opacity: 0.7;
      }
      @keyframes pulse {
        0%,
        100% {
          box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7);
        }
        50% {
          box-shadow: 0 0 0 10px rgba(0, 123, 255, 0);
        }
      }
      .log {
        background: #1e1e1e;
        color: #d4d4d4;
        padding: 15px;
        border-radius: 8px;
        max-height: 400px;
        overflow-y: auto;
        font-family: "Consolas", "Courier New", monospace;
        font-size: 13px;
      }
      .log-entry {
        margin: 5px 0;
        padding: 8px;
        border-left: 4px solid #007bff;
        padding-left: 12px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 4px;
      }
      .log-entry.success {
        border-color: #28a745;
        color: #7dff7d;
      }
      .log-entry.error {
        border-color: #dc3545;
        color: #ff7d7d;
      }
      .log-entry.info {
        border-color: #17a2b8;
        color: #7dd3ff;
      }
      .log-entry.warning {
        border-color: #ffc107;
        color: #ffe97d;
      }
      .controls {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }
      .form-group {
        display: flex;
        flex-direction: column;
        margin: 10px 0;
      }
      .form-group label {
        font-weight: 600;
        margin-bottom: 5px;
        color: #555;
      }
      .seat-info {
        font-size: 10px;
        margin-top: 5px;
        color: #666;
      }
      .trip-info {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #667eea;
      }
      .trip-info h4 {
        margin-top: 0;
        color: #667eea;
      }
      .badge {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        margin: 2px;
      }
      .badge.available {
        background: #d4edda;
        color: #155724;
      }
      .badge.locked {
        background: #fff3cd;
        color: #856404;
      }
      .badge.booked {
        background: #f8d7da;
        color: #721c24;
      }
      .booking-form {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-top: 15px;
      }
      .selected-seats {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin: 10px 0;
      }
      .selected-seat-badge {
        background: #007bff;
        color: white;
        padding: 8px 15px;
        border-radius: 20px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .selected-seat-badge button {
        background: rgba(255, 255, 255, 0.3);
        border: none;
        color: white;
        padding: 2px 8px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 12px;
      }
      .model-viewer {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        font-family: "Courier New", monospace;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
      }
      .api-endpoint {
        background: #1e1e1e;
        color: #7dff7d;
        padding: 10px 15px;
        border-radius: 6px;
        font-family: "Consolas", monospace;
        margin: 10px 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .api-method {
        background: #667eea;
        padding: 4px 8px;
        border-radius: 4px;
        font-weight: bold;
        margin-right: 10px;
      }
      .legend {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        margin: 15px 0;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
      }
      .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .legend-box {
        width: 30px;
        height: 30px;
        border-radius: 6px;
        border: 2px solid;
      }
      .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 2px solid #ddd;
      }
      .tab {
        padding: 10px 20px;
        cursor: pointer;
        border: none;
        background: transparent;
        font-weight: 600;
        color: #666;
        border-bottom: 3px solid transparent;
        transition: all 0.3s;
      }
      .tab.active {
        color: #667eea;
        border-bottom-color: #667eea;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>üöå Bus Booking System - WebSocket Testing Tool</h1>
      <p>
        Complete testing suite for seat locking, real-time updates, and booking
        flow
      </p>
    </div>

    <div class="container">
      <h2>‚öôÔ∏è K·∫øt n·ªëi</h2>
      <div class="controls">
        <label>Server URL:</label>
        <input
          type="text"
          id="serverUrl"
          value="http://localhost:5230/ws"
          style="width: 300px"
        />
        <label>Trip ID:</label>
        <input type="number" id="tripId" value="1" style="width: 100px" />
        <label>User ID:</label>
        <input
          type="text"
          id="userId"
          value="user_test_1"
          style="width: 150px"
        />
        <button onclick="connect()">K·∫øt n·ªëi</button>
        <button onclick="disconnect()" id="disconnectBtn" disabled>
          Ng·∫Øt k·∫øt n·ªëi
        </button>
      </div>
      <div id="connectionStatus" class="status disconnected">
        ‚ùå Ch∆∞a k·∫øt n·ªëi
      </div>
    </div>

    <div class="container">
      <h2>ü™ë S∆° ƒë·ªì gh·∫ø (Test seats)</h2>
      <div class="controls">
        <button onclick="loadSeats()" id="loadSeatsBtn">
          T·∫£i danh s√°ch gh·∫ø
        </button>
        <button onclick="createTestSeats()" id="createTestSeatsBtn">
          T·∫°o test seats
        </button>
        <button onclick="clearAllLocks()">X√≥a t·∫•t c·∫£ locks (Admin)</button>
      </div>
      <div id="seatGrid" class="seat-grid">
        <!-- Seats will be loaded here -->
      </div>
    </div>

    <div class="container">
      <h2>üß™ Test Actions</h2>
      <div class="controls">
        <label>Seat ID:</label>
        <input type="number" id="testSeatId" value="1" style="width: 100px" />
        <button onclick="lockSeat()">üîí Lock gh·∫ø</button>
        <button onclick="unlockSeat()">üîì Unlock gh·∫ø</button>
        <button onclick="confirmBooking()">‚úÖ Confirm Booking</button>
      </div>
    </div>

    <div class="container">
      <h2>üìã Logs</h2>
      <button onclick="clearLogs()">X√≥a logs</button>
      <div id="logContainer" class="log"></div>
    </div>

    <script>
      let stompClient = null;
      let currentTripId = null;
      let currentUserId = null;
      let seats = new Map();

      function log(message, type = "info") {
        const logContainer = document.getElementById("logContainer");
        const entry = document.createElement("div");
        entry.className = `log-entry ${type}`;
        const timestamp = new Date().toLocaleTimeString();
        entry.textContent = `[${timestamp}] ${message}`;
        logContainer.insertBefore(entry, logContainer.firstChild);
      }

      function connect() {
        const serverUrl = document.getElementById("serverUrl").value;
        currentTripId = document.getElementById("tripId").value;
        currentUserId = document.getElementById("userId").value;

        log(`ƒêang k·∫øt n·ªëi ƒë·∫øn ${serverUrl}...`, "info");

        const socket = new SockJS(serverUrl);
        stompClient = Stomp.over(socket);

        stompClient.connect(
          {},
          function (frame) {
            log("‚úÖ K·∫øt n·ªëi WebSocket th√†nh c√¥ng!", "success");
            document.getElementById("connectionStatus").className =
              "status connected";
            document.getElementById("connectionStatus").textContent =
              "‚úÖ ƒê√£ k·∫øt n·ªëi";
            document.getElementById("disconnectBtn").disabled = false;

            // Subscribe to seat updates
            const topic = `/topic/trips/${currentTripId}/seats`;
            log(`ƒêang subscribe to: ${topic}`, "info");

            stompClient.subscribe(topic, function (message) {
              const seatUpdate = JSON.parse(message.body);
              log(
                `üì¢ Nh·∫≠n broadcast: ${seatUpdate.type} - Seat ${
                  seatUpdate.seatNumber || seatUpdate.seatId
                }`,
                "info"
              );
              console.log("Seat update:", seatUpdate);
              updateSeatUI(seatUpdate);
            });

            // Subscribe to personal responses
            stompClient.subscribe(
              "/user/queue/seat/response",
              function (message) {
                const response = JSON.parse(message.body);
                if (response.success) {
                  log(
                    `‚úÖ ${response.type}: Seat ${response.seatId}`,
                    "success"
                  );
                } else {
                  log(`‚ùå ${response.type}: ${response.message}`, "error");
                }
              }
            );

            // Load seats after connection
            loadSeats();
          },
          function (error) {
            log(`‚ùå L·ªói k·∫øt n·ªëi: ${error}`, "error");
            document.getElementById("connectionStatus").className =
              "status disconnected";
            document.getElementById("connectionStatus").textContent =
              "‚ùå L·ªói k·∫øt n·ªëi";
          }
        );
      }

      function disconnect() {
        if (stompClient !== null) {
          stompClient.disconnect();
          log("ƒê√£ ng·∫Øt k·∫øt n·ªëi WebSocket", "info");
        }
        document.getElementById("connectionStatus").className =
          "status disconnected";
        document.getElementById("connectionStatus").textContent =
          "‚ùå ƒê√£ ng·∫Øt k·∫øt n·ªëi";
        document.getElementById("disconnectBtn").disabled = true;
      }

      function lockSeat(seatId = null) {
        if (!stompClient || !stompClient.connected) {
          alert("Vui l√≤ng k·∫øt n·ªëi WebSocket tr∆∞·ªõc!");
          return;
        }

        const sid = seatId || document.getElementById("testSeatId").value;
        const message = {
          seatId: parseInt(sid),
          tripId: parseInt(currentTripId),
          userId: currentUserId,
        };

        log(`üîí ƒêang g·ª≠i lock request cho seat ${sid}...`, "info");
        stompClient.send("/app/seat/lock", {}, JSON.stringify(message));
      }

      function unlockSeat(seatId = null) {
        if (!stompClient || !stompClient.connected) {
          alert("Vui l√≤ng k·∫øt n·ªëi WebSocket tr∆∞·ªõc!");
          return;
        }

        const sid = seatId || document.getElementById("testSeatId").value;
        const message = {
          seatId: parseInt(sid),
          tripId: parseInt(currentTripId),
          userId: currentUserId,
        };

        log(`üîì ƒêang g·ª≠i unlock request cho seat ${sid}...`, "info");
        stompClient.send("/app/seat/unlock", {}, JSON.stringify(message));
      }

      async function loadSeats() {
        const tripId = document.getElementById("tripId").value;
        log(`ƒêang t·∫£i danh s√°ch gh·∫ø cho trip ${tripId}...`, "info");

        try {
          const response = await fetch(
            `http://localhost:5230/api/trips/seats/${tripId}`
          );
          const data = await response.json();

          if (data.success && data.data && data.data.floors) {
            seats.clear();
            data.data.floors.forEach((floor) => {
              floor.seats.forEach((seat) => {
                seats.set(seat.seatId, seat);
              });
            });
            renderSeats();
            log(`‚úÖ ƒê√£ t·∫£i ${seats.size} gh·∫ø`, "success");
          } else {
            log(
              `‚ö†Ô∏è Ch∆∞a c√≥ seats cho trip ${tripId}. T·∫°o test seats tr∆∞·ªõc!`,
              "error"
            );
          }
        } catch (error) {
          log(`‚ùå L·ªói t·∫£i seats: ${error.message}`, "error");
        }
      }

      function renderSeats() {
        const grid = document.getElementById("seatGrid");
        grid.innerHTML = "";

        if (seats.size === 0) {
          grid.innerHTML =
            '<p>Ch∆∞a c√≥ gh·∫ø n√†o. Click "T·∫°o test seats" ƒë·ªÉ t·∫°o d·ªØ li·ªáu test.</p>';
          return;
        }

        seats.forEach((seat, seatId) => {
          const seatDiv = document.createElement("div");
          seatDiv.className = "seat";
          seatDiv.id = `seat-${seatId}`;

          let className = "available";
          let statusText = "‚úÖ Tr·ªëng";

          if (seat.status === "ƒê√£ ƒë·∫∑t") {
            className = "booked";
            statusText = "‚ùå ƒê√£ ƒë·∫∑t";
          } else if (seat.status === "ƒêang gi·ªØ") {
            if (seat.lockedBy === currentUserId) {
              className = "locked-by-me";
              statusText = "üîí C·ªßa t√¥i";
            } else {
              className = "locked";
              statusText = "‚è≥ ƒêang gi·ªØ";
            }
          }

          seatDiv.className += " " + className;

          const expiryInfo = seat.holdExpiry
            ? `<div class="seat-info">H·∫øt h·∫°n: ${new Date(
                seat.holdExpiry
              ).toLocaleTimeString()}</div>`
            : "";
          const lockedByInfo = seat.lockedBy
            ? `<div class="seat-info">B·ªüi: ${seat.lockedBy}</div>`
            : "";

          seatDiv.innerHTML = `
                    <div><strong>${
                      seat.seatNumber || "Seat " + seatId
                    }</strong></div>
                    <div>${statusText}</div>
                    ${lockedByInfo}
                    ${expiryInfo}
                `;

          if (className === "available") {
            seatDiv.onclick = () => lockSeat(seatId);
          } else if (className === "locked-by-me") {
            seatDiv.onclick = () => unlockSeat(seatId);
          }

          grid.appendChild(seatDiv);
        });
      }

      function updateSeatUI(seatUpdate) {
        if (!seatUpdate.seatId) return;

        // Update in-memory seat data
        const seat = seats.get(seatUpdate.seatId) || {};
        seat.seatId = seatUpdate.seatId;
        seat.seatNumber = seatUpdate.seatNumber || seat.seatNumber;
        seat.status = seatUpdate.status;
        seat.lockedBy = seatUpdate.lockedBy;
        seat.holdExpiry = seatUpdate.lockExpiry;
        seats.set(seatUpdate.seatId, seat);

        // Re-render seats
        renderSeats();
      }

      async function createTestSeats() {
        const tripId = document.getElementById("tripId").value;
        log(`ƒêang t·∫°o test seats cho trip ${tripId}...`, "info");

        try {
          const response = await fetch(
            `http://localhost:5230/api/trips/${tripId}/seat-map/migrate`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ overwrite: true }),
            }
          );

          const data = await response.json();

          if (data.success) {
            log(`‚úÖ ƒê√£ t·∫°o test seats th√†nh c√¥ng!`, "success");
            await loadSeats();
          } else {
            log(`‚ùå L·ªói t·∫°o seats: ${data.message}`, "error");
          }
        } catch (error) {
          log(`‚ùå L·ªói: ${error.message}`, "error");
        }
      }

      async function confirmBooking() {
        const seatId = document.getElementById("testSeatId").value;
        log(`ƒêang confirm booking cho seat ${seatId}...`, "info");

        try {
          const response = await fetch(
            "http://localhost:5230/api/seats/confirm-booking",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                seatId: parseInt(seatId),
                tripId: parseInt(currentTripId),
                userId: currentUserId,
                paymentId: "payment_test_" + Date.now(),
              }),
            }
          );

          const data = await response.json();

          if (data.success) {
            log(`‚úÖ Booking confirmed!`, "success");
          } else {
            log(`‚ùå L·ªói: ${data.message}`, "error");
          }
        } catch (error) {
          log(`‚ùå L·ªói: ${error.message}`, "error");
        }
      }

      async function clearAllLocks() {
        if (!confirm("X√≥a t·∫•t c·∫£ locks? (Admin action)")) return;

        log("ƒêang x√≥a t·∫•t c·∫£ locks...", "info");
        // This would require an admin endpoint - for now, just reload
        await loadSeats();
      }

      function clearLogs() {
        document.getElementById("logContainer").innerHTML = "";
      }

      // Auto-connect on page load (optional)
      // window.onload = () => connect();
    </script>
  </body>
</html>
